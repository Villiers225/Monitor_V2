async function loadJSON(p){const r=await fetch(p,{cache:'no-store'});return r.json()}const state={articles:[],themes:null,sortKey:'date',sortDir:'desc',search:'',tag:'',onlyRecommended:false};function fmtDate(i){const d=new Date(i);return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'})}function setSort(k){if(state.sortKey===k){state.sortDir=state.sortDir==='asc'?'desc':'asc'}else{state.sortKey=k;state.sortDir='desc'};renderTable()}function getLiked(){try{return new Set(JSON.parse(localStorage.getItem('likedArticles')||'[]'))}catch(e){return new Set()}}function toggleLike(id){const s=getLiked();s.has(id)?s.delete(id):s.add(id);localStorage.setItem('likedArticles',JSON.stringify([...s]));renderTable()}function renderCharts(){if(!state.themes)return;const tc=state.themes.themes.slice(0,12),sc=state.themes.top_solutions.slice(0,12);new Chart(document.getElementById('themesChart'),{type:'bar',data:{labels:tc.map(x=>x.name),datasets:[{label:'Theme mentions',data:tc.map(x=>x.count)}]},options:{plugins:{legend:{display:false}}}});new Chart(document.getElementById('solutionsChart'),{type:'bar',data:{labels:sc.map(x=>x.text.slice(0,30)),datasets:[{label:'Solution mentions',data:sc.map(x=>x.count)}]},options:{plugins:{legend:{display:false}}}})}function renderTable(){const tb=document.querySelector('#articlesTable tbody');tb.innerHTML='';const liked=getLiked(),thr=0.35;let rows=state.articles.slice();if(state.search){const q=state.search.toLowerCase();rows=rows.filter(a=>(a.title||'').toLowerCase().includes(q)||(a.source||'').toLowerCase().includes(q)||(a.tags||[]).some(t=>t.toLowerCase().includes(q)))}if(state.tag){rows=rows.filter(a=>(a.tags||[]).includes(state.tag))}if(state.onlyRecommended){rows=rows.filter(a=>(a.relevance_score||0)>=thr)}rows.sort((a,b)=>{let va=a[state.sortKey],vb=b[state.sortKey];if(state.sortKey==='date'){va=new Date(va).getTime();vb=new Date(vb).getTime()}return va<vb?(state.sortDir==='asc'?-1:1):va>vb?(state.sortDir==='asc'?1:-1):0});for(const a of rows){const tr=document.createElement('tr');tr.innerHTML=`<td>${fmtDate(a.date)}</td><td><a href='${a.url}' target='_blank' rel='noopener'>${a.title||'(untitled)'}</a><div class='source'>${a.summary||''}</div></td><td>${a.source||''}</td><td>${(a.relevance_score??0).toFixed(2)}</td><td>${(a.tags||[]).map(t=>`<span class='badge'>${t}</span>`).join('')}</td><td class='star ${liked.has(a.id)?'on':''}' title='Like to steer future ranking'>â˜…</td>`;tr.querySelector('.star').addEventListener('click',()=>toggleLike(a.id));tb.appendChild(tr)}}async function init(){const[articles,themes]=await Promise.all([loadJSON('./articles.json').catch(()=>loadJSON('./articles.sample.json')),loadJSON('./themes.json').catch(()=>loadJSON('./themes.sample.json'))]);state.articles=articles;state.themes=themes;const counts={};for(const a of articles){for(const t of(a.tags||[])){counts[t]=(counts[t]||0)+1}}const tagFilter=document.getElementById('tagFilter');Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([t,c])=>{const opt=document.createElement('option');opt.value=t;opt.textContent=`${t} (${c})`;tagFilter.appendChild(opt)});document.getElementById('search').addEventListener('input',e=>{state.search=e.target.value;renderTable()});tagFilter.addEventListener('change',e=>{state.tag=e.target.value;renderTable()});document.getElementById('recoFilter').addEventListener('change',e=>{state.onlyRecommended=e.target.value==='recommended';renderTable()});document.querySelectorAll('th[data-key]').forEach(th=>th.addEventListener('click',()=>setSort(th.dataset.key)));renderCharts();renderTable()}init();